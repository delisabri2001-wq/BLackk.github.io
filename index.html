<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLack World | Community</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üåà">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- STILE BASE --- */
        :root { --primary: #1b4332; --accent: #2d6a4f; --soft: #f0f7f4; --white: #ffffff; --text: #333; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { margin: 0; background: var(--soft); color: var(--text); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER & NAV */
        header { background: var(--primary); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        nav { background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000; height: 60px; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links a { text-decoration: none; color: #333; font-weight: 600; cursor: pointer; text-transform: uppercase; font-size: 0.85rem; padding: 10px; transition: 0.3s; }
        .nav-links a.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* SIDEBAR */
        .sidebar { position: fixed; left: -100%; top: 0; width: 350px; height: 100%; background: white; z-index: 2000; transition: 0.4s; padding: 20px; box-shadow: 5px 0 25px rgba(0,0,0,0.1); overflow-y: auto; }
        .sidebar.open { left: 0; }
        
        /* CONTENUTO */
        .container { max-width: 900px; margin: 20px auto; padding: 0 20px; flex: 1; width: 100%; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* TINDER STYLE */
        .tinder-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
        .swipe-card { width: 100%; max-width: 350px; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; transition: 0.3s; display: flex; flex-direction: column; }
        .swipe-img-container { width: 100%; height: 350px; position: relative; }
        .swipe-img { width: 100%; height: 100%; object-fit: cover; }
        .swipe-info { padding: 20px; text-align: left; }
        .swipe-name { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .swipe-controls { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .btn-swipe { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .btn-swipe.nope { background: white; color: #ff4757; border: 2px solid #ff4757; }
        .btn-swipe.love { background: var(--accent); color: white; border: 2px solid var(--accent); }
        .btn-swipe:hover { transform: scale(1.1); }

        /* PROFILO FULL */
        .profile-cover { height: 120px; background: linear-gradient(45deg, var(--primary), var(--accent)); border-radius: 12px 12px 0 0; margin: -20px -20px 50px -20px; }
        .profile-avatar-big { width: 120px; height: 120px; border-radius: 50%; border: 5px solid white; position: absolute; left: 50%; top: 60px; transform: translateX(-50%); object-fit: cover; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* INPUT & BUTTONS */
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; outline: none; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--accent); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn-social { background: white; border: 1px solid #ddd; padding: 10px; width: 100%; margin-top: 5px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold; color: #555; }

        /* CHAT */
        .chat-container { height: 350px; overflow-y: auto; border: 1px solid #eee; padding: 15px; background: #fafafa; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .msg { padding: 10px 14px; border-radius: 15px; background: #eee; max-width: 80%; font-size: 0.9rem; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--accent); color: white; }
        .msg.anon { background: #e0f7fa; border: 1px solid #b2ebf2; align-self: flex-start; }

        /* QUIZ */
        .quiz-btn { width: 100%; padding: 15px; border: 1px solid #ddd; background: #fff; text-align: left; margin-bottom: 8px; cursor: pointer; border-radius: 8px; transition:0.2s; }
        .quiz-btn:hover { background: #f0f0f0; }
        .quiz-btn.correct { background: #d4edda; color: #155724; border-color:#c3e6cb; }
        .quiz-btn.wrong { background: #f8d7da; color: #721c24; border-color:#f5c6cb; }

        /* FOOTER & TOAST */
        footer { background: #222; color: #ccc; padding: 30px 20px; text-align: center; font-size: 0.85rem; margin-top: auto; }
        footer a { color: white; text-decoration: underline; cursor: pointer; margin: 0 10px; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 4000; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 0.9rem; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        #toast.success { background-color: var(--accent); }
        #toast.error { background-color: #c0392b; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<header><h1>BLACK WORLD üåà</h1></header>

<nav>
    <div style="position: absolute; left: 20px; top: 18px; cursor: pointer; font-weight: bold; color: var(--primary);" onclick="toggleSidebar()">
        ‚öôÔ∏è MENU
    </div>
    <div class="nav-links">
        <a onclick="navTo('home', this)" class="active">Home</a>
        <a onclick="navTo('amicizia', this)">Match üî•</a>
        <a onclick="navTo('chat', this)">Chat</a>
        <a onclick="navTo('giochi', this)">Giochi</a>
    </div>
</nav>

<div class="sidebar" id="sidebar">
    <div style="text-align:right; cursor:pointer; font-size: 1.2rem; color:#888;" onclick="toggleSidebar()">‚úï CHIUDI</div>
    <div id="authArea">
        <h3>Accedi</h3>
        <button class="btn-social" onclick="socialLogin()"><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="18"> Google</button>
        <hr style="margin: 20px 0;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="Password">
        <button class="btn-main" onclick="emailAuth('login')">ENTRA</button>
        <button class="btn-main" style="background:#888;" onclick="emailAuth('reg')">REGISTRATI</button>
    </div>
    <div id="userArea" style="display:none;">
        <h3 style="text-align:center;">Ciao, <span id="sidebarNick">User</span>! üëã</h3>
        <button class="btn-main" onclick="openMyProfile()">üë§ IL MIO PROFILO</button>
        <button class="btn-main" style="background:#2d3436; margin-top:10px;" onclick="toggleEdit()">‚úèÔ∏è MODIFICA</button>
        <div id="editForm" class="edit-form" style="display:none; margin-top:10px;">
            <label>Foto (Max 700KB)</label>
            <input type="file" id="fileInput" accept="image/*">
            <input type="text" id="pNick" placeholder="Nickname">
            <input type="number" id="pAge" placeholder="Et√†">
            <input type="text" id="pShip" placeholder="La tua Ship (es. NetJJ)">
            <input type="text" id="pSocial" placeholder="Social (es. IG @nome)">
            <textarea id="pStory" rows="3" placeholder="Bio..."></textarea>
            <button class="btn-main" id="btnSave" onclick="saveProfile()">üíæ SALVA</button>
        </div>
        <hr style="margin:20px 0;">
        <button class="btn-main" style="background:#c0392b;" onclick="logout()">LOGOUT</button>
    </div>
</div>

<div class="container">
    
    <section id="home" class="page active">
        <div class="card" style="text-align:center; padding:40px;">
            <h2 style="color:var(--primary);">Benvenuta in BLack World üåø</h2>
            <p style="font-size:1.1rem;">La community per fangirl aggiornata al 2025.</p>
            <button class="btn-main" style="max-width:300px;" onclick="navTo('amicizia')">üî• INIZIA A SWIPARE</button>
        </div>
        <div class="card">
            <h3>üèÜ Classifica Quiz</h3>
            <table style="width:100%; border-collapse:collapse;" id="leaderboard"></table>
        </div>
    </section>

    <section id="userProfilePage" class="page">
        <div class="card" style="text-align:center; padding:0; overflow:hidden;">
            <div class="profile-cover"></div>
            <img id="pubAvatar" src="" class="profile-avatar-big">
            <div style="padding: 60px 20px 30px 20px;">
                <h2 id="pubNick" style="margin:0;">Nome</h2>
                <p id="pubShip" style="color:var(--accent); font-weight:bold; margin-top:5px;">Ship</p>
                <div style="margin: 20px 0; font-size:1.1rem;">Et√†: <b id="pubAge">-</b> ‚Ä¢ Punti: <b id="pubScore">0</b></div>
                <div style="font-style:italic; color:#555; margin:20px 0;">"<span id="pubStory">...</span>"</div>
                <div style="background:#f9f9f9; padding:15px; border-radius:8px;">üì± Social: <b id="pubSocial">-</b></div>
                <button class="btn-social" style="margin-top:20px;" onclick="navTo('amicizia')">üîô Torna ai Match</button>
            </div>
        </div>
    </section>

    <section id="amicizia" class="page">
        <div class="card" style="text-align:center; padding:15px;">
            <h3 style="margin:0 0 10px 0;">üíò Trova la tua Ship Friend</h3>
            <p style="font-size:0.9rem; color:#666;">Filtra per ship (es. PerthSanta, NetJJ, OhmLeng...)</p>
            <input type="text" id="shipFilter" placeholder="üîç Scrivi ship..." onkeyup="reloadDeck()" style="text-align:center; font-weight:bold; color:var(--primary);">
        </div>

        <div id="deckContainer" class="tinder-container">
            <div id="loadingDeck" style="text-align:center; color:#888;">Caricamento profili...</div>
        </div>

        <div class="card" style="margin-top:30px; border: 2px solid #00bcd4; background:#e0f7fa;">
            <h3 style="color:#0097a7;">üì¢ Bacheca Pubblica</h3>
            <div id="anonChatBox" class="chat-container" style="height:200px; background:white;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="anonNick" placeholder="Nome" style="width:30%;">
                <input type="text" id="anonInput" placeholder="Messaggio...">
                <button class="btn-main" style="width:80px; background:#00bcd4;" onclick="sendAnonMsg()">Invia</button>
            </div>
        </div>
    </section>

    <section id="chat" class="page">
        <div class="card" style="border: 2px solid var(--primary);">
            <h3 style="color:var(--primary);">‚ú® Chat VIP</h3>
            <div id="chatBox" class="chat-container"></div>
            <div id="chatControls" style="display:flex; gap:10px;">
                <input type="text" id="chatInput" placeholder="Messaggio..." style="margin:0;">
                <button class="btn-main" style="width:100px; margin:0;" onclick="sendMsg()">Invia</button>
            </div>
            <p id="chatLockMsg" style="color:red; text-align:center; display:none;">üîí Registrati per scrivere!</p>
        </div>
    </section>

    <section id="giochi" class="page">
        <div id="quizMenu" class="card">
            <h3>Quiz Time! üéÆ</h3>
            <p>Mettiti alla prova con le ship aggiornate!</p>
            <button class="btn-main" onclick="startQuiz('gmmtv')">üè¢ Quiz GMMTV (2025)</button>
            <button class="btn-main" style="background:#2980b9;" onclick="startQuiz('domundi')">üêâ Quiz DOMUNDI (2025)</button>
        </div>
        <div id="quizActive" class="card" style="display:none;">
            <h3 id="qTitle">Domanda</h3>
            <p id="qText" style="font-size:1.2rem; font-weight:600;">...</p>
            <div id="qOpts"></div>
            <p id="qFeed" style="font-weight:bold; text-align:center; margin-top:10px;"></p>
        </div>
    </section>

</div>

<div id="toast">Notifica</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAr4cM8wb7kSHpaFDGjlDZcm15t1LyL4Do",
      authDomain: "black-world-91efc.firebaseapp.com",
      databaseURL: "https://black-world-91efc-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "black-world-91efc",
      messagingSenderId: "1075556185722",
      appId: "1:1075556185722:web:a18a5f3d7ef3b4862aedc3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    function showToast(msg, type='normal') {
        const x = document.getElementById("toast"); x.innerText = msg; x.className = "show " + type;
        setTimeout(()=>{ x.className = x.className.replace("show", ""); }, 3000);
    }
    function navTo(page, el) {
        toggleSidebar(true);
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(page).classList.add('active');
        document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
        if(el) el.classList.add('active');
        window.scrollTo(0,0);
        if(page==='amicizia') { loadSwipeDeck(); loadAnonChat(); }
        if(page==='chat') loadChat();
        if(page==='home') loadLeaderboard();
    }
    function toggleSidebar(forceClose=false) { 
        const sb = document.getElementById('sidebar');
        if(forceClose) sb.classList.remove('open'); else sb.classList.toggle('open');
    }
    function toggleEdit() { const f=document.getElementById('editForm'); f.style.display = f.style.display==='block'?'none':'block'; }

    // --- NUOVI QUIZ AGGIORNATI AL 2025/2026 ---
    const DB_QUIZ = {
        gmmtv: [
            {q: "Chi √® il partner ufficiale di Ohm Pawat nella serie 'Kidnap'?", a: ["Nanon", "Leng", "Perth"], c: 1},
            {q: "Come si chiama la coppia protagonista di 'Perfect 10 Liners'?", a: ["PerthChimon", "PerthSanta", "ForceBook"], c: 1},
            {q: "In 'My Love Mix-Up!' (versione Thai), chi sono i protagonisti?", a: ["EarthMix", "GeminiFourth", "PondPhuwin"], c: 1},
            {q: "Chi recita insieme a Inn Sarin in 'Wandee Goodday'?", a: ["Great", "Drake", "Pod"], c: 0},
            {q: "Boun e Prem sono entrati ufficialmente in GMMTV?", a: ["No", "S√¨, con la serie Revamp", "Solo Boun"], c: 1},
            {q: "In 'We Are Series', chi √® in coppia con Satang?", a: ["Winny", "Mark", "Ford"], c: 0},
            {q: "Qual √® la serie di Joss e Gawin?", a: ["My Golden Blood", "The Player", "Not Me"], c: 0},
            {q: "Chi canta 'You're Blushing?' in 'Only Boo!'?", a: ["Keen", "Sea", "Aou"], c: 0},
            {q: "Quale coppia storica √® tornata con 'Ossan's Love'?", a: ["OffGun", "TayNew", "EarthMix"], c: 2},
            {q: "Chi interpreta Moo in 'Only Boo!'?", a: ["Keen", "Sea Dechchart", "Aungpao"], c: 0}
        ],
        domundi: [
            {q: "Chi √® il NUOVO partner di Net dopo James?", a: ["JJ", "Yim", "Tutor"], c: 0},
            {q: "Come si chiama la serie storica (period) di ZeeNuNew?", a: ["Cutie Pie 2", "The Next Prince", "Naughty Babe"], c: 1},
            {q: "In 'Khemjira', chi √® il partner di Keng?", a: ["Namping", "First", "Latte"], c: 0},
            {q: "Qual √® la serie 2024 di MaxNat ambientata in mondi paralleli?", a: ["Two Worlds", "Middleman's Love", "Bed Friend"], c: 0},
            {q: "Chi sono i protagonisti di 'Battle of the Writers'?", a: ["NetJames", "TutorYim", "JimmyTommy"], c: 1},
            {q: "Thomas √® in coppia con...?", a: ["Kong", "First", "Gems"], c: 0},
            {q: "Come si chiama la Gen 3 di Domundi?", a: ["DMD Gen 3", "DMD Friendship", "New Gen"], c: 1},
            {q: "Chi canta la maggior parte delle OST Domundi?", a: ["Zee", "NuNew", "Nat"], c: 1},
            {q: "In che serie recitano FirstOne?", a: ["Love Upon a Time", "Punk Spy", "Zomvivor"], c: 0},
            {q: "Chi √® il partner di Mark nel nuovo progetto?", a: ["Ohm", "Gems", "Park"], c: 0}
        ]
    };

    let qI=0, pts=0, type=null;
    function startQuiz(t) { if(!auth.currentUser) return showToast("Login necessario"); type=t; qI=0; pts=0; document.getElementById('quizMenu').style.display='none'; document.getElementById('quizActive').style.display='block'; showQ(); }
    function showQ() {
        if(qI>=DB_QUIZ[type].length) { 
            showToast("Quiz finito! Punti: "+pts+"/10", "success"); 
            db.ref('users/'+auth.currentUser.uid+'/score').transaction(s=>(s||0)+pts); 
            document.getElementById('quizMenu').style.display='block'; 
            document.getElementById('quizActive').style.display='none'; 
            return; 
        }
        const d=DB_QUIZ[type][qI]; 
        document.getElementById('qTitle').innerText=`Domanda ${qI+1}/10`; 
        document.getElementById('qText').innerText=d.q; 
        document.getElementById('qFeed').innerText=""; 
        document.getElementById('qOpts').innerHTML=d.a.map((a,i)=>`<div class="quiz-btn" onclick="chk(${i},${d.c},this)">${a}</div>`).join('');
    }
    function chk(s,c,e) { 
        document.querySelectorAll('.quiz-btn').forEach(b=>b.onclick=null); // Blocca click multipli
        if(s===c){e.classList.add('correct'); pts++; document.getElementById('qFeed').innerText="CORRETTO! ‚úÖ";}
        else{e.classList.add('wrong'); document.getElementById('qFeed').innerText="SBAGLIATO ‚ùå";} 
        setTimeout(()=>{qI++; showQ();},1500); 
    }

    // --- TINDER LOGIC ---
    let currentDeck = [], deckIndex = 0;
    function reloadDeck() { deckIndex = 0; loadSwipeDeck(); }
    function loadSwipeDeck() {
        const c = document.getElementById('deckContainer');
        const f = document.getElementById('shipFilter').value.toLowerCase();
        c.innerHTML = '<div style="text-align:center; color:#888; margin-top:50px;">üîç Cerco fan...</div>';
        db.ref('users').once('value', s => {
            currentDeck = [];
            const myUid = auth.currentUser ? auth.currentUser.uid : null;
            s.forEach(u => {
                const user = u.val(); user.uid = u.key;
                if(user.uid !== myUid) {
                    if(!f || (user.ship && user.ship.toLowerCase().includes(f))) currentDeck.push(user);
                }
            });
            currentDeck.sort(() => Math.random() - 0.5);
            deckIndex = 0;
            renderCard();
        });
    }
    function renderCard() {
        const c = document.getElementById('deckContainer');
        if(deckIndex >= currentDeck.length) {
            c.innerHTML = `<div style="text-align:center; padding:40px;"><h3>üéâ Finito!</h3><p>Nessun altro profilo trovato.</p><button class="btn-main" onclick="loadSwipeDeck()">üîÑ Ricomincia</button></div>`;
            return;
        }
        const u = currentDeck[deckIndex];
        const pic = u.avatar || `https://ui-avatars.com/api/?name=${u.nick}&background=random`;
        const ship = u.ship ? `üíñ ${u.ship}` : "";
        c.innerHTML = `
            <div class="swipe-card" id="activeCard">
                <div class="swipe-img-container"><img src="${pic}" class="swipe-img"></div>
                <div class="swipe-info">
                    <h3 class="swipe-name">${u.nick}</h3>
                    <span style="color:var(--accent); font-weight:bold;">${ship}</span>
                    <p style="font-style:italic; color:#666;">${u.story || "..."}</p>
                </div>
            </div>
            <div class="swipe-controls">
                <button class="btn-swipe nope" onclick="swipe('left')">‚úï</button>
                <button class="btn-swipe love" onclick="swipe('right','${u.uid}')">üíö</button>
            </div>`;
    }
    function swipe(dir, uid) {
        const card = document.getElementById('activeCard');
        card.style.transform = dir==='left' ? "translateX(-100px) rotate(-10deg)" : "translateX(100px) rotate(10deg)";
        card.style.opacity = "0";
        if(dir==='right') { showToast("Match! üíö", "success"); setTimeout(()=>openUserProfile(uid),300); }
        else { setTimeout(()=>{ deckIndex++; renderCard(); },300); }
    }

    // --- PROFILI & AUTH ---
    function openUserProfile(uid) {
        navTo('userProfilePage');
        db.ref('users/'+uid).once('value',s=>{
            const u=s.val();
            document.getElementById('pubNick').innerText=u.nick;
            document.getElementById('pubShip').innerText=u.ship||"";
            document.getElementById('pubAge').innerText=u.age||"-";
            document.getElementById('pubScore').innerText=u.score||0;
            document.getElementById('pubStory').innerText=u.story||"...";
            document.getElementById('pubSocial').innerText=u.social||"Privato";
            document.getElementById('pubAvatar').src=u.avatar||"";
        });
    }
    function openMyProfile() { if(auth.currentUser) openUserProfile(auth.currentUser.uid); }
    function emailAuth(t){
        const e=document.getElementById('email').value, p=document.getElementById('pass').value;
        if(!e||!p) return showToast("Mancano dati","error");
        (t==='login'?auth.signInWithEmailAndPassword(e,p):auth.createUserWithEmailAndPassword(e,p))
        .then(()=>showToast("Benvenuta!","success")).catch(e=>showToast(e.message,"error"));
    }
    function socialLogin(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout(){ auth.signOut().then(()=>location.reload()); }
    auth.onAuthStateChanged(u=>{
        if(u){
            document.getElementById('authArea').style.display='none';
            document.getElementById('userArea').style.display='block';
            document.getElementById('chatLockMsg').style.display='none';
            db.ref('users/'+u.uid).on('value', s=>{
                const d=s.val()||{};
                document.getElementById('sidebarNick').innerText=d.nick||"User";
                document.getElementById('pNick').value=d.nick||""; document.getElementById('pAge').value=d.age||"";
                document.getElementById('pShip').value=d.ship||""; document.getElementById('pSocial').value=d.social||"";
                document.getElementById('pStory').value=d.story||"";
            });
        } else {
            document.getElementById('authArea').style.display='block';
            document.getElementById('userArea').style.display='none';
            document.getElementById('chatLockMsg').style.display='block';
        }
    });
    function saveProfile() {
        const u=auth.currentUser; if(!u) return;
        const btn=document.getElementById('btnSave'); btn.innerText="‚è≥"; btn.disabled=true;
        const f=document.getElementById('fileInput').files[0];
        const d={ nick:document.getElementById('pNick').value, age:document.getElementById('pAge').value, ship:document.getElementById('pShip').value, social:document.getElementById('pSocial').value, story:document.getElementById('pStory').value, uid:u.uid };
        if(f) {
            if(f.size>700000){showToast("Foto grande! Max 700KB","error"); btn.innerText="SALVA"; btn.disabled=false; return;}
            const r=new FileReader(); r.onload=e=>{ d.avatar=e.target.result; db.ref('users/'+u.uid).update(d).then(()=>{showToast("Salvato!","success"); toggleEdit(); btn.innerText="SALVA"; btn.disabled=false;}); }; r.readAsDataURL(f);
        } else { db.ref('users/'+u.uid).update(d).then(()=>{showToast("Salvato!","success"); toggleEdit(); btn.innerText="SALVA"; btn.disabled=false;}); }
    }
    function loadChat(){ db.ref('chat').limitToLast(20).on('value',s=>{ const b=document.getElementById('chatBox'); b.innerHTML=""; s.forEach(c=>{ const m=c.val(); const me=auth.currentUser&&m.uid===auth.currentUser.uid; b.innerHTML+=`<div class="msg ${me?'me':''}"><b><span onclick="openUserProfile('${m.uid}')" style="cursor:pointer">${m.nick}</span>:</b> ${m.text}</div>`; }); b.scrollTop=b.scrollHeight; }); }
    function sendMsg(){ if(!auth.currentUser)return showToast("Login necessario"); const t=document.getElementById('chatInput').value; if(t){ db.ref('chat').push({text:t,uid:auth.currentUser.uid,nick:document.getElementById('pNick').value}); document.getElementById('chatInput').value=""; } }
    function loadAnonChat(){ db.ref('bacheca').limitToLast(15).on('value',s=>{ const b=document.getElementById('anonChatBox'); b.innerHTML=""; const my=localStorage.getItem('anonNick'); s.forEach(c=>{ const m=c.val(); b.innerHTML+=`<div class="msg anon ${m.nick===my?'me':''}"><b>${m.nick}:</b> ${m.text}</div>`; }); b.scrollTop=b.scrollHeight; }); }
    function sendAnonMsg(){ const t=document.getElementById('anonInput').value, n=document.getElementById('anonNick').value; if(n&&t){ localStorage.setItem('anonNick',n); db.ref('bacheca').push({text:t,nick:n}); document.getElementById('anonInput').value=""; } }
    function loadLeaderboard(){ db.ref('users').orderByChild('score').limitToLast(5).on('value',s=>{ const t=document.getElementById('leaderboard'); t.innerHTML=""; let a=[]; s.forEach(c=>a.push({k:c.key,n:c.val().nick,s:c.val().score||0})); a.sort((x,y)=>y.s-x.s).forEach((p,i)=>t.innerHTML+=`<tr><td>#${i+1} <b onclick="openUserProfile('${p.k}')" style="cursor:pointer">${p.n}</b></td><td style="text-align:right;">${p.s}</td></tr>`); }); }
</script>
</body>
</html>
